# 가상 메모리

OS는 MMU를 사용해 메모리가 실제 메모리보다 많아 보이게 하는 기술인 가상 메모리를 제공한다.

장점은 아래와 같이 3가지다.

1.사용자가 기억장소를 일일히 할당하는 불편을 없애준다.

2.프로세스의 크기가 실제 메모리의 용량을 초과해도 실행될 수가 있다.

3.설사 물리적 메모리의 용량이 충분히 크다하더라도 다중 프로그래밍이 가능하다.

### 가상 메모리와 MMU의 관계

<img width="600" alt="image" src="https://user-images.githubusercontent.com/91880235/172724924-5f1d7772-8036-44f9-87f6-68b4fcd3c282.png">

CPU는 가상 메모리 주소를 다루고, 실제 해당 주소 접근 시 MMU 하드웨어 장치를 통해 물리 메모리에 접근한다.
하드웨어 장치를 이용해야 주소 변환이 빠르기 때문에 MMU라는 별도의 장치를 두고 있는 것이다.

paging system을 사용하면 프로세스에서 나눠진 page를 언제 물리 메모리에 올려놓을지에 대한 정책이 필요하다. 선행 페이징으로 하면 그냥 프로세슬를 실행하자마다 page먼저 다 올려두는 것인데 이것 보다 실제로 필요할 때 page를 메모리에 올리는 것이 좋을 것이다. 이게 demand paging이다.

### 요구불 페이징(Demand Paging)

- `Demand Paging`: 프로세스의 모든 데이터를 메모리로 적재하지 않고, 실행 중 필요한 시점에서만 메모리로 적재함
  이 때 valid/Invalid bit가 사용된다.

- `Invalid`: 사용되지 않는 주소 영역인 경우, 페이지가 물리적 메모리에 없는 경우 (valid는 반대)
  처음에는 모든 page가 invalid로 초기화되고, 사용되면 valid로 되는데, address translation시에 invalid bit이라면 page fault가 발생한다.

- `Page fault`: 어떤 페이지가 물리 메모리에 없을 때 발생하는 인터럽트로, page fault가 발생하면 운영체제가 해당 페이지를 물리 메모리에 올려준다.

요청받은 메모리가 사용 가능한 메모리의 크기보다 크다면 `Swap Out`,
읽어오는 동작은 `Swap In`
이런 식으로 페이지 처리하는 것을 `요구불 페이징(Demand Paging)` 이라고 한다.

### 페이지 교체 정책(Page Replacement policy)

운영체제가 특정 페이지를 물리 메모리에 올리려고 하는데 물리 메모리가 다 차있다면? 기존 페이지 중 하나르 물리 메모리에서 저장 매체로 내리고(저장) 새로운 페이지를 해당 물리 메모리 공간에 올려야한다. 이 때 어떤 페이지를 물리 메모리에서, 저장 매체로 내릴 것인가에 대한 것이 페이지 교체 정책이다.

1. `FIFO 알고리즘

가장 먼저 들어온 페이지를 내린다.

2. `OPT(OPTimal) 알고리즘`

앞으로 가장 오랫동안 사용하지 않을 페이지를 내린다. => 그러나 미래에 어떤 페이지를 얼마나 사용할 것인지는 알 수 없으므로 일반 OS에서는 구현이 불가하다.
스와핑이 일어나면 시스템 성능이 크게 저하된다.

3. `LRU(Least Recently Used) 알고리즘`

가장 오래전에 사용된 페이지를 내리자 라는 아이디어로, OPT 알고리즘이 미래의 일을 알 수 없으므로 구현이 불가하므로, LRU에서는 과거 기록을 기반으로 시도한 것이다.

4. `LFU(Least Frequently Used) 알고리즘`

가장 적게 사용된 페이지를 내리자.

성능 저하를 막기 위해 `최소 최근 사용(LRU, Least Recently Used) 알고리즘`이 사용된다.

5. `NUR(Not Used Recently) 알고리즘

LRU와 마찬가지로 최근에 사용하지 않은 페이지부터 내리자는 알고리즘인데, 각 페이지마다 참조 여부를 나타내는 비트(R), 수정 여부를 나타내는 비트(M)을 두어서 (0, 0), (0, 1), (1, 0), (1, 1) 순으로 교체한다.

<br>

### 참고

- [[운영체제] 가상 메모리의 이해](https://libertegrace.tistory.com/m/entry/%EC%9A%B4%EC%98%81%EC%B2%B4%EC%A0%9C-%EA%B0%80%EC%83%81-%EB%A9%94%EB%AA%A8%EB%A6%AC%EC%9D%98-%EC%9D%B4%ED%95%B4)
- []()
